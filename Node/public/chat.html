<!doctype html>
<html>
	<head>
		<title>ShellCord</title>
		<style>
			* { margin: 0; padding: 0; box-sizing: border-box; }
			body { font: 13px Helvetica, Arial; background-color: #232323; color: #fff}
			form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
			form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
			form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
			#messages { list-style-type: none; margin: 0; padding: 0; }
			#messages li { padding: 5px 10px; }
			#messages li:nth-child(odd) { background: #232323; border-top: 1px #404040 dashed; border-bottom: 1px #404040 dashed;}
			.green{ color : #32c146; }
			.blue{ color: #6e6e9a; }
		</style>
	</head>
	<body>
		<ul id="messages"></ul>
		<form action="">
			<input id="m" autocomplete="off" /><button>Send</button>
		</form>
		
		<script src="/socket.io/socket.io.js"></script>
		<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
		<script>
			$(function () {
				let mySound = new Audio('http://www.yamishadow.fr/Telechargement/keyblade_appears.mp3');
				mySound.load();
				let socket = io();

				//recuperation de GET
				let pseudoGet = $_GET('pseudo')
				let salonGet = $_GET('salon')
				//Connexion d'un nouveau user
				socket.emit('new_user', pseudoGet, salonGet)
				//Modification du title d'onglet du navigateur
				document.title = pseudoGet + ' - ' + salonGet + ' - ' + document.title
				
				//Affiche la réponse du serveur pour new_user
				socket.on('new_user', function(data) {
					$('#messages').append($('<li class="green" style="font-weight: bold;">').text('$ '+data.pseudo + ' a rejoint ShellCord dans le salon '+data.salon+' !'))
				})
						
				//Affiche la réponse du serveur pour goodbye_user
				socket.on('goodbye_user', function(pseudo) {
					$('#messages').append($('<li class="green" style="font-weight: bold;">').text('$ '+pseudo + ' a quitter ShellCord !'))
				})

				//Affiche la réponse du serveur pour switch_channel / chat_privateMessageError
				socket.on('chat_messageBrute', function(msg) {
					$('#messages').append($('<li class="green" style="font-weight: bold;">').text('$ '+msg))
				})

				//Affiche la réponse du serveur pour chat_messagePrivate
				socket.on('chat_messagePrivate', function(msg) {
					$('#messages').append($('<li class="blue" style="font-weight: bold;">').text('$ '+msg))
				})
						
				//Affiche la réponse du serveur pour quit_user
				socket.on('quit_user', function(msg) {
					$('#messages').append($('<li style="font-weight: bold;color:#32c146">').text('$ Vous avez été déconnecté !'))
					socket.close()
				})
						
				//Traitement du formulaire
				socket.on('chat_message', function(data){
					$('#messages').append($('<li>').text(data.pseudo+' - $ '+data.message))
					mySound.play()
				});

				//Traitement du formulaire
				$('form').submit(function(){
					socket.emit('chat_message', $('#m').val())
					$('#m').val('')
					return false
				});
			});

			//Fonction qui emule la methode GET de PHP
			function $_GET(param) {
				let vars = {}
				window.location.href.replace( location.hash, '' ).replace( 
					/[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
					function( m, key, value ) { // callback
						vars[key] = value !== undefined ? value : ''
					}
				);

				if (param) {
					return vars[param] ? vars[param] : null	
				}
				return vars
			}
		</script>
	</body>
</html>